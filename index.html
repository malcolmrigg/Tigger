<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>crisp-game-lib</title>
    <meta
      name="viewport"
      content="width=device-width, height=device-height,
    user-scalable=no, initial-scale=1, maximum-scale=1"
    />
    <script src="https://unpkg.com/sounds-some-sounds@3.0.0/build/index.js"></script>
    <script src="https://unpkg.com/gif-capture-canvas@1.1.0/build/index.js"></script>
    <script src="https://unpkg.com/pixi.js@5.3.0/dist/pixi.min.js"></script>
    <script src="https://unpkg.com/pixi-filters@3.1.1/dist/pixi-filters.js"></script>
    <script src="https://unpkg.com/crisp-game-lib@1.1.1/docs/bundle.js"></script>

<script>
title = "Tigger Game";

description = `
Escape the
 piglets!
`;

characters = [];

/** @type {Vector[]} */
let piglets;
/** @type {Vector[]} */
let deadPiglets;

/** @type {Vector} */
let tigger;

options = {
  isReplayEnabled: true,
  isPlayingBgm: true,
  seed: 5,
  viewSize: {
    x: 100,
    y: 100
  }
};

function update() {
  if (!ticks) {
    screensize = options.viewSize.x;
    level = 1;
    piglets = [];
    deadPiglets = [];
    pigMoveDist = screensize/1000;
    tigMoveDist = screensize/500;
    pigletColor = "light_red";
    deadPigletColor = "black";
    tiggerColor = "red";
    pigSize = 3;
    tiggerSize = 5;
  }

  // Reset for next level
  if (piglets.length == 0){
    play("powerUp");
    level++;
    deadPiglets = [];
    for (l=1; l<=level; l++){
      // Spread the piglets around the perimeter
      if (l%4==3){ 
        // top
        piglets.push(vec(rnd(pigSize,screensize-pigSize), rnd(pigSize,screensize/5)));
      } else if (l%4==2){ 
        // right
        piglets.push(vec(rnd(screensize-screensize/5,screensize-pigSize), rnd(pigSize,screensize-pigSize)));
      } else if (l%4==1){ 
        // bottom
        piglets.push(vec(rnd(pigSize,screensize-pigSize), rnd(screensize-screensize/5,screensize-pigSize)));
      } else {
        // left
        piglets.push(vec(rnd(pigSize,screensize/5), rnd(pigSize,screensize-pigSize)));
      }
    }
    // Put tigger in the middle
    tigger = vec(screensize/2,screensize/2);
  }

  // Move tigger towards mouse/touch
  if (input.isPressed)
  {
    if (clamp(input.pos.x, tiggerSize, screensize-tiggerSize) > tigger.x){
      tigger.x += tigMoveDist;
    } else if (clamp(input.pos.x, tiggerSize, screensize-tiggerSize) < tigger.x) {
      tigger.x -= tigMoveDist;
    }
    if (clamp(input.pos.y, tiggerSize, screensize-tiggerSize) > tigger.y){
      tigger.y += tigMoveDist;
    } else if (clamp(input.pos.y, tiggerSize, screensize-tiggerSize) < tigger.y) {
      tigger.y -= tigMoveDist;
    }
  }

  // Draw tigger
  color(tiggerColor);
  box(tigger, tiggerSize);

  // Check for game-ending collisions
  piglets.forEach((pn) => {
    if (abs(pn.x-tigger.x)<((pigSize+tiggerSize)/2) && abs(pn.y-tigger.y)<((pigSize+tiggerSize)/2)) {
      play("explosion");
      end();
    }
  });

  // Move piglets
  piglets.forEach((p) => {
    if (tigger.x > p.x){
      p.x += pigMoveDist;
    } else if (tigger.x < p.x) {
      p.x -= pigMoveDist;
    }
    if (tigger.y > p.y){
      p.y += pigMoveDist;
    } else if (tigger.y < p.y) {
      p.y -= pigMoveDist;
    }
  });

  // Check for piglet-ending collisions
  remove(piglets, (p) => {
    dead = false;
    deadPiglets.forEach((pn) => {
      if (p != pn && abs(pn.x-p.x)<pigSize && abs(pn.y-p.y)<pigSize) {
        dead = true;
      }
    });
    if (!dead){
      piglets.forEach((pn) => {
        if (p != pn && abs(pn.x-p.x)<pigSize && abs(pn.y-p.y)<pigSize) {
          dead = true;
        }
      });
    }
    if (dead){
      deadPiglets.push(p);
      addScore(1,p);
      play("hit");
      particle(p, 8);
    };
    return dead;
  });

  // Draw piglets that are still alive
  piglets.forEach((p) => {
    color(pigletColor);
    box(p, pigSize);
  });

  // Draw dead piglets
  deadPiglets.forEach((p) => {
    color(deadPigletColor);
    box(p, pigSize);
  });
}

addEventListener("load", onLoad);
</script>

  </head>
  <body style="background: #ddd"></body>
</html>
